# 18.06.11

## Cloud9 - Ruby

````ruby'
=begin

1. 다음, 네이버 웹툰에서 웹툰 데이터를 크롤링한다.
2. 두 사이트에서 받아온 데이터 형태를 일치시킨다. 데이터는 웹툰제목, 썸네일 이미지, 웹툰을 볼수 있는 링크
3. 랜덤으로 비복원추출을 하려면 배열 형태로 데이터를 만든다.
4. 배열안에 있는 웹튼 1개의 데이터는 해쉬(딕셔너리) 형태로 만든다.
4. 웹튼 3개를 뽑아서 <table>태그를 이용하여 표로 보여준다.

추가과제
1. 각 요일별로 추출하기
2. 버튼에 일 ~ 토요일까지 버튼을 만들고, /webtoon?day=mon
=end

````

#### gem conflict시 대처법

````command
# gem conflict

gem list sinatra 		 ()
gem list 				( 깔려 있는 gem 이 다 나옴.)

gem uninstall sinatra
ruby app.rb -o $IP -p $PORT
````

### 코드 작성

	#### app.rb - /webtoon 작성

* 다음 웹툰 페이지에서 웹툰 내용 크롤링 해서 3개 랜덤으로 뽑기

````ruby
require 'sinatra'
# require 'sinatra/reloader'
require 'json'
require 'rest-client'
require 'nokogiri'
require 'csv'

get '/' do
    erb :index
end

get '/webtoon' do
    
    # daumurl = RestClient.get(URI.encode("http://comic.naver.com/webtoon/weekday.nhn"))
    # result = Nokokgiri::HTML.parse(daumurl)
    # mon1 = result.css('#content > div.list_area.daily_all > div.col.col_selected > div > ul > li:nth-child(1) > a')
    # puts mon1
    
    # @mon1.text   => 
    
    ################################ 뭐 부터 먼저 해야하는가?
    
    # 내가 받아온 웹툰 데이터를 저장할 배열 생성
    # 웹툰 데이터를 받아올 url 파악 및 요청 보내기
    # 응답으로 온 내용을 해쉬 형태로 바꾸기
    # 해쉬에서 웹툰 리스트에 해당하는 부분 순환하기
    # 필요한 부분을 분리해서 처음 만든 배열에 push 
    
    # jason formatter 설치
    
    # 내가 받아온 웹툰 데이터를 저장할 배열 생성
    toons = []
    # 웹툰 데이터를 받아올 url 파악 및 요청 보내기
    url = "http://webtoon.daum.net/data/pc/webtoon/list_serialized/mon"
    result = RestClient.get(url)
    # 응답으로 온 내용을 해쉬 형태로 바꾸기
    webtoons = JSON.parse(result)
    # 해쉬에서 웹툰 리스트에 해당하는 부분 순환하기
    webtoons["data"].each do |toon|
    # http://webtoon.daum.net/data/pc/webtoon/list_serialized/mon 에서 
        # 웹툰 제목
        title = toon["title"]
        # 웹툰 이미지 주소  
        image = toon["thumbnailImage2"]["url"]  # 썸네일 안에서 url을 뽑아야됨.
        # 웹툰을 볼 수 있는 주소
        link = "http://webtoon.daum.net/webtoon/view#{toon["nickname"]}"
    # 필요한 부분을 분리해서 처음 만든 배열에 push 
        toons << {"title" => title, # title이라는 키의 값(value)은 title 
                "image" => image,
                "link" => link
                }
    end
    # 완성된 배열 중에서 3개의 웹툰만 랜덤 추출
    # view에서도 쓸 수 있는 걸 만들어주어야함.
    @daum_webtoon = toons.sample(3)
    erb :webtoon
end
````

#### index.erb

````html
<html>
    <head>
        <body>
            <ol>
                <a href="/webtoon"><h1><li> 웹툰 종합 </li></h1></a>
                <a href="/check_file"><h1><li> 파일 확인 </li></h1></a>
                <a href="/webtoon"><h1><li>  </li></h1></a>                
                <a href="/webtoon"><h1><li>  </li></h1></a>
            </ol>
        </body>
    </head>
</html>
````

##### webtoon.erb

````html
<table>
    <thead>
        <th> 이미지 </th>
        <th> 타이틀 </th>
        <th> 링크 </th>
    </thead>
    <tbody>
        
        <!-- tr이 한 뭉터기이므로, 여기서 반복처리를 해줘야함.-->
        <% @daum_webtoon.each do |toon| %>
        <tr>
            <td<img src="<%= toon["image"] %>"></td>
            <td><%= toon["title"] %></td>
            <td><a href="<%= toon["link"] %>">보러가기</a></td>
        </tr>
        <% end %>   <!-- 눈에 보이지 않음 -->
    </tbody>
</table>
````



#### Ruby 문법

* 객체 - attribute 속성 = 모든 것이 메서드고, 객체이다.



#### check_file

````ruby
1. 데이터는 기본적으로 한번만 받아온다.        # root 폴더로
2. 만약에 데이터가 있으면, 전체 목록을 불러오는 `/`로 리디렉션 해준다.
3. 만약에 데이터가 없으면, 모든 정보를 저장하는 CSV 파일을 새로 만들어준다.
````

````csv
	1,신의탑,네이버아디,누구,누구,링크,네이버
	2,스타워즈,다음아디,누구,누구,링크,카카오	
````

4. CSV 파일

https://stackoverflow.com/questions/17866291/what-is-the-second-parameter-argument-to-csv-open-in-ruby

````command
CSV.open

From the IO Open Mode documentation:
"r" Read-only, starts at beginning of file (default mode).
"r+" Read-write, starts at beginning of file.
"w" Write-only, truncates existing file to zero length or creates a new file for writing.
"w+" Read-write, truncates existing file to zero length or creates a new file for reading and writing.
"a" Write-only, starts at end of file if file exists, otherwise creates a new file for writing.
"a+" Read-write, starts at end of file if file exists, otherwise creates a new file for reading and writing.

````

````ruby
get '/check_file' do
    # 파일이 있는지 없는지 어떻게 파악할까요?
    
#   if CSV.read('./test.csv').nil? 
#    if File.file?('./test.csv')  # 현재 경로에서 csv 파일이 있니?  .nil? 이게 비어있니?

    unless File.file?('./test.csv')
        puts "파일이 없습니다."         # 파일 존재 여부 판단.
        # CSV 파일을 새로 생성하는 코드
        CSV.open('/test.csv','w+') do |row|
            row << ["1","title1", "img_url1", "link1"]
            row << ["2","title2", "img_url2", "link2"]
            row << ["3","title3", "img_url3", "link3"]
            
        end
        erb :check_file
    else
        # 존재하는 csv 파일을 불러오는 코드
        CSV.open('./test.csv', 'r+').each do |row|
            @webtoons << row
            #puts row.
        end
        puts @webtoons
        erb :webtoons
    end
end
````

````html
<table>
    <thead>
        <th> 이미지 </th>
        <th> 타이틀 </th>
        <th> 링크 </th>
    </thead>
    <tbody>
        <!-- tr이 한 뭉터기이므로, 여기서 반복처리를 해줘야함.-->
        <% @webtoons.each do |toon| %>
        <tr>
            <td><%= toon[0] &> </td>
            <td><%= toon[2] &> </td>
            <td><%= toon[1] &> </td>
            <td><%= toon[3] &> </td>
        </tr>
        <% end %>   <!-- 눈에 보이지 않음 -->
    </tbody>
</table>
````









